alias: Legionella â€“ 1Ã— per 14 dagen rond goedkoopste uur v2
description: >
  Plant eens per 14 dagen een legionella-run rond het goedkoopste uur. Slimme
  sensor-wissel na 15:30u, identiek aan SWW-logica.
triggers:
  - trigger: homeassistant
    event: start
  - trigger: time
    at: "15:30:00"
  - trigger: time
    at: "16:30:00"
  - trigger: time
    at: "17:30:00"
  - trigger: time
    at: "18:30:00"
  - trigger: time
    at: "22:00:00"
conditions: []
actions:
  - if:
      - condition: template
        value_template: "{{ trigger.platform == 'homeassistant' }}"
    then:
      - action: notify.pushover_ha
        data:
          title: "[Legionella] âœ… Automatisering gestart"
          message: >
            Legionella-automatisering actief na HA herstart. Laatste run: {{
            (legionella_last | as_datetime).strftime('%d-%m-%Y om %H:%M') }}.
            Dagen geleden: {{ dagen_geleden }}. {% if moet_draaien %}Status: âš ï¸
            Run nodig (>= 14 dagen geleden). {% else %}Volgende run: Over {{ 14
            - dagen_geleden }} dagen. {% endif %} {% if actieve_tijd not in
            [None, 'unknown', 'unavailable', ''] and moet_draaien %} Gepland {{
            actieve_label }}: {{ (actieve_tijd | as_datetime).strftime('%H:%M
            uur') }} ({{ actieve_prijs }} ct/kWh). {% elif moet_draaien and
            now().hour >= 15 and not morgen_prijzen_bekend %} âš ï¸ Morgen prijzen
            nog niet bekend - wacht op Tibber update. {% endif %} Planning
            check: Dagelijks om 15:30u.
  - if:
      - condition: template
        value_template: "{{ moet_draaien and (now().hour >= 15 or now().hour == 22) }}"
    then:
      - choose:
          - conditions:
              - condition: template
                value_template: >-
                  {{ vandaag_goedkoopste_geweest and not morgen_prijzen_bekend
                  }}
            sequence:
              - action: notify.pushover_ha
                data:
                  title: "[Legionella] â³ Prijzen nog niet bekend"
                  message: >
                    Morgen-prijzen nog niet beschikbaar om {{
                    now().strftime('%H:%M uur') }}. Goedkoopste uur vandaag ({{
                    (vandaag_tijd | as_datetime).strftime('%H:%M') }}) is al
                    geweest. Legionella-run (14 dagen geleden) wacht op
                    Tibber-update. Check elk uur opnieuw tot {{ now().hour + 3
                    }}:30u.
          - conditions:
              - condition: template
                value_template: "{{ actieve_tijd not in [None, 'unknown', 'unavailable', ''] }}"
            sequence:
              - action: notify.pushover_ha
                data:
                  title: "[Legionella] ðŸ“… {{ actieve_label | title }} gepland"
                  message: >
                    Legionella-run {{ actieve_label }} om {{ (actieve_tijd |
                    as_datetime).strftime('%H:%M uur') }} op {{ (actieve_tijd |
                    as_datetime | as_local).strftime('%d-%m-%Y') }}. Prijs op
                    dat moment: {{ actieve_prijs }} ct/kWh. Laatste run: {{
                    dagen_geleden }} dagen geleden. Duur: 90 minuten (â‰¥60Â°C voor
                    bacteriedoding).
              - wait_template: |
                  {% set target = actieve_tijd | as_datetime %}
                  {{ target != none and now() >= target }}
                timeout: "23:00:00"
                continue_on_timeout: true
              - if:
                  - condition: template
                    value_template: "{{ not wait.completed }}"
                then:
                  - action: notify.pushover_ha
                    data:
                      title: "[Legionella] âš ï¸ Timeout - Noodstart"
                      message: >
                        Wachten op goedkoopste uur liep af (timeout).
                        Legionella-run wordt NU gestart als veiligheidsmaatregel
                        om {{ now().strftime('%H:%M uur') }}. Huidige prijs: {{
                        states('sensor.ab27hia_huidige_elektriciteitsprijs_2') |
                        float(0) | round(2) }} ct/kWh.
                else:
                  - action: notify.pushover_ha
                    data:
                      title: "[Legionella] ðŸ”¥ Activeren..."
                      message: >
                        Legionella Prevention wordt nu gestart om {{
                        now().strftime('%H:%M uur') }}. Prijs: {{
                        states('sensor.ab27hia_huidige_elektriciteitsprijs_2') |
                        float(0) | round(2) }} ct/kWh.
              - action: select.select_option
                target:
                  entity_id: select.ecodan_heatpump_status_bedrijf
                data:
                  option: Legionella Prevention
              - wait_for_trigger:
                  - trigger: state
                    entity_id: sensor.ecodan_heatpump_operation_mode
                    to: Legionella Prevention
                timeout: "00:10:00"
                continue_on_timeout: true
              - if:
                  - condition: template
                    value_template: "{{ wait.completed }}"
                then:
                  - action: notify.pushover_ha
                    data:
                      title: "[Legionella] âœ… Gestart"
                      message: >
                        Legionella Prevention actief om {{ now().strftime('%H:%M
                        uur') }}. Doel: â‰¥60Â°C gedurende 90 minuten voor
                        bacteriedoding. Verwachte eindtijd: {{ (now() +
                        timedelta(minutes=90)).strftime('%H:%M uur') }}.
                else:
                  - action: notify.pushover_ha
                    data:
                      title: "[Legionella] âš ï¸ Waarschuwing"
                      message: >
                        Legionella Prevention mode niet gedetecteerd binnen 10
                        minuten om {{ now().strftime('%H:%M uur') }}. Controleer
                        handmatig of de run is gestart!
              - delay: "01:30:00"
              - action: select.select_option
                target:
                  entity_id: select.ecodan_heatpump_status_bedrijf
                data:
                  option: "{{ oude_bedrijfsstatus }}"
              - action: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.legionella_last_done
                data:
                  timestamp: "{{ now().timestamp() }}"
              - action: notify.pushover_ha
                data:
                  title: "[Legionella] âœ… Afgerond"
                  message: >
                    Legionella-run afgerond om {{ now().strftime('%H:%M uur') }}
                    (90 min). Bedrijfsstatus teruggezet naar {{
                    oude_bedrijfsstatus }}. Volgende run over ~14 dagen ({{
                    (now() + timedelta(days=14)).strftime('%d-%m-%Y') }}).
variables:
  vandaag_prijs: "{{ states('sensor.tibber_vandaag_laagste_prijs') | float(999) }}"
  vandaag_tijd: "{{ state_attr('sensor.tibber_vandaag_laagste_prijs', 'timestamp') }}"
  morgen_prijs: "{{ states('sensor.tibber_morgen_laagste_prijs') | float(999) }}"
  morgen_tijd: "{{ state_attr('sensor.tibber_morgen_laagste_prijs', 'timestamp') }}"
  legionella_last: "{{ states('input_datetime.legionella_last_done') }}"
  dagen_geleden: |-
    {% if legionella_last in ['unknown', 'unavailable', ''] %}
      999
    {% else %}
      {{ ((as_timestamp(now()) - as_timestamp(legionella_last)) / 86400) | round(0) | int }}
    {% endif %}
  moet_draaien: "{{ dagen_geleden >= 14 }}"
  oude_bedrijfsstatus: "{{ states('select.ecodan_heatpump_status_bedrijf') }}"
  morgen_prijzen_bekend: >-
    {{ morgen_tijd not in [None, 'unknown', 'unavailable', ''] and morgen_prijs
    < 999 }}
  vandaag_goedkoopste_geweest: >-
    {% set vandaag_uur = vandaag_tijd | as_datetime %} {{ vandaag_uur != none
    and now().hour > vandaag_uur.hour }}
  gebruik_morgen_sensor: >-
    {{ now().hour >= 15 and vandaag_goedkoopste_geweest and
    morgen_prijzen_bekend }}
  actieve_prijs: "{{ morgen_prijs if gebruik_morgen_sensor else vandaag_prijs }}"
  actieve_tijd: "{{ morgen_tijd if gebruik_morgen_sensor else vandaag_tijd }}"
  actieve_label: "{{ 'morgen' if gebruik_morgen_sensor else 'vandaag' }}"
mode: single
max_exceeded: silent
